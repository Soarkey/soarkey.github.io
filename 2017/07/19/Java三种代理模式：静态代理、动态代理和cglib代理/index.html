
<!DOCTYPE html>
<html lang="zh-Hans" class="loading">
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soarkey的博客 - Stay hungry. Stay foolish.</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="soarkey,"> 
    <meta name="description" content="求知若饥，虚心若愚,"> 
    <meta name="author" content="Soarkey"> 
    <link rel="alternative" href="atom.xml" title="Soarkey的博客" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="/css/diaspora.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>
<body class="loading">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">Java三种代理模式：静态代理、动态代理和cglib代理</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div>
        <h1 class="title">Java三种代理模式：静态代理、动态代理和cglib代理</h1>
        <div class="stuff">
            <span> 2017, 七月, 19</span>
        </div>
        <div class="content markdown">
            <h1 id="一、代理模式介绍"><a href="#一、代理模式介绍" class="headerlink" title="一、代理模式介绍"></a>一、代理模式介绍</h1><p><a href="https://zh.wikipedia.org/wiki/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F" target="_blank" rel="external">代理模式</a>是一种设计模式，提供了对目标对象额外的访问方式，即通过代理对象访问目标对象，这样可以在不修改原目标对象的前提下，提供额外的功能操作，扩展目标对象的功能。</p>
<p>简言之，代理模式就是设置一个中间代理来控制访问原目标对象，以达到增强原对象的功能和简化访问方式。</p>
<blockquote>
<p>代理模式UML类图</p>
</blockquote>
<p><img src="https://static.oschina.net/uploads/img/201707/18202945_lHIa.png" alt="代理模式UML类图" title="代理模式UML类图"></p>
<p>举个例子，我们生活中经常到火车站去买车票，但是人一多的话，就会非常拥挤，于是就有了代售点，我们能从代售点买车票了。这其中就是代理模式的体现，代售点代理了火车站对象，提供购买车票的方法。</p>
<h1 id="二、静态代理"><a href="#二、静态代理" class="headerlink" title="二、静态代理"></a>二、静态代理</h1><p>这种代理方式需要代理对象和目标对象实现一样的接口。</p>
<p>优点：可以在不修改目标对象的前提下扩展目标对象的功能。</p>
<p>缺点：</p>
<ol>
<li>冗余。由于代理对象要实现与目标对象一致的接口，会产生过多的代理类。</li>
<li>不易维护。一旦接口增加方法，目标对象与代理对象都要进行修改。</li>
</ol>
<blockquote>
<p>举例：保存用户功能的静态代理实现</p>
</blockquote>
<ul>
<li>接口类： IUserDao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserDao</span> </span>&#123;</div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>目标对象：UserDao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">IUserDao</span></span>&#123;</div><div class="line"></div><div class="line">true<span class="meta">@Override</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">truetrueSystem.out.println(<span class="string">"保存数据"</span>);</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>静态代理对象：UserDapProxy   <strong><em>需要实现IUserDao接口！</em></strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDaoProxy</span> <span class="keyword">implements</span> <span class="title">IUserDao</span></span>&#123;</div><div class="line"></div><div class="line">true<span class="keyword">private</span> IUserDao target;</div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="title">UserDaoProxy</span><span class="params">(IUserDao target)</span> </span>&#123;</div><div class="line">truetrue<span class="keyword">this</span>.target = target;</div><div class="line">true&#125;</div><div class="line">true</div><div class="line">true<span class="meta">@Override</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">truetrueSystem.out.println(<span class="string">"开启事务"</span>);<span class="comment">//扩展了额外功能</span></div><div class="line">truetruetarget.save();</div><div class="line">truetrueSystem.out.println(<span class="string">"提交事务"</span>);</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试类：TestProxy</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticUserProxy</span> </span>&#123;</div><div class="line">true<span class="meta">@Test</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testStaticProxy</span><span class="params">()</span></span>&#123;</div><div class="line">truetrue<span class="comment">//目标对象</span></div><div class="line">truetrueIUserDao target = <span class="keyword">new</span> UserDao();</div><div class="line">truetrue<span class="comment">//代理对象</span></div><div class="line">truetrueUserDaoProxy proxy = <span class="keyword">new</span> UserDaoProxy(target);</div><div class="line">truetrueproxy.save();</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>输出结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">开启事务</div><div class="line">保存数据</div><div class="line">提交事务</div></pre></td></tr></table></figure>
<h1 id="三、动态代理"><a href="#三、动态代理" class="headerlink" title="三、动态代理"></a>三、动态代理</h1><p>动态代理利用了<a href="http://tool.oschina.net/uploads/apidocs/jdk-zh/" target="_blank" rel="external">JDK API</a>，动态地在内存中构建代理对象，从而实现对目标对象的代理功能。动态代理又被称为JDK代理或接口代理。</p>
<p>静态代理与动态代理的区别主要在：</p>
<ul>
<li>静态代理在编译时就已经实现，编译完成后代理类是一个实际的class文件</li>
<li>动态代理是在运行时动态生成的，即编译完成后没有实际的class文件，而是在运行时动态生成类字节码，并加载到JVM中</li>
</ul>
<p><strong>特点：</strong><br>动态代理对象不需要实现接口，但是要求目标对象必须实现接口，否则不能使用动态代理。</p>
<p>JDK中生成代理对象主要涉及的类有</p>
<ul>
<li><a href="http://tool.oschina.net/uploads/apidocs/jdk-zh/java/lang/reflect/Proxy.html" target="_blank" rel="external">java.lang.reflect Proxy</a>，主要方法为<figure class="highlight delphi"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">Object</span>	newProxyInstance(ClassLoader loader,  <span class="comment">//指定当前目标对象使用类加载器</span></div><div class="line"></div><div class="line"> <span class="keyword">Class</span>&lt;?&gt;[] interfaces,    <span class="comment">//目标对象实现的接口的类型</span></div><div class="line"> InvocationHandler h      <span class="comment">//事件处理器</span></div><div class="line">) </div><div class="line"><span class="comment">//返回一个指定接口的代理类实例，该接口可以将方法调用指派到指定的调用处理程序。</span></div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><a href="http://tool.oschina.net/uploads/apidocs/jdk-zh/java/lang/reflect/InvocationHandler.html" target="_blank" rel="external">java.lang.reflect  InvocationHandler</a>，主要方法为<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> <span class="function">Object	<span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> </span></div><div class="line"><span class="comment">// 在代理实例上处理方法调用并返回结果。</span></div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>举例：保存用户功能的动态代理实现</p>
</blockquote>
<ul>
<li>接口类： IUserDao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IUserDao</span> </span>&#123;</div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>目标对象：UserDao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span> <span class="keyword">implements</span> <span class="title">IUserDao</span></span>&#123;</div><div class="line"></div><div class="line">true<span class="meta">@Override</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">truetrueSystem.out.println(<span class="string">"保存数据"</span>);</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>动态代理对象：UserProxyFactory </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> </span>&#123;</div><div class="line"></div><div class="line">true<span class="keyword">private</span> Object target;<span class="comment">// 维护一个目标对象</span></div><div class="line"></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="title">ProxyFactory</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">truetrue<span class="keyword">this</span>.target = target;</div><div class="line">true&#125;</div><div class="line"></div><div class="line">true<span class="comment">// 为目标对象生成代理对象</span></div><div class="line">true<span class="function"><span class="keyword">public</span> Object <span class="title">getProxyInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">truetrue<span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(),</div><div class="line">truetruetruetrue<span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line"></div><div class="line">truetruetruetruetrue<span class="meta">@Override</span></div><div class="line">truetruetruetruetrue<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">truetruetruetruetruetrueSystem.out.println(<span class="string">"开启事务"</span>);</div><div class="line"></div><div class="line">truetruetruetruetruetrue<span class="comment">// 执行目标对象方法</span></div><div class="line">truetruetruetruetruetrueObject returnValue = method.invoke(target, args);</div><div class="line"></div><div class="line">truetruetruetruetruetrueSystem.out.println(<span class="string">"提交事务"</span>);</div><div class="line">truetruetruetruetruetrue<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">truetruetruetruetrue&#125;</div><div class="line">truetruetruetrue&#125;);</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试类：TestProxy </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.proxy;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProxy</span> </span>&#123;</div><div class="line"></div><div class="line">true<span class="meta">@Test</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDynamicProxy</span> <span class="params">()</span></span>&#123;</div><div class="line">truetrueIUserDao target = <span class="keyword">new</span> UserDao();</div><div class="line">truetrueSystem.out.println(target.getClass());  <span class="comment">//输出目标对象信息</span></div><div class="line">truetrueIUserDao proxy = (IUserDao) <span class="keyword">new</span> ProxyFactory(target).getProxyInstance();</div><div class="line">truetrueSystem.out.println(proxy.getClass());  <span class="comment">//输出代理对象信息</span></div><div class="line">truetrueproxy.save();  <span class="comment">//执行代理方法</span></div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>输出结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">class com.proxy.UserDao</div><div class="line">class com.sun.proxy.<span class="variable">$Proxy4</span></div><div class="line">开启事务</div><div class="line">保存数据</div><div class="line">提交事务</div></pre></td></tr></table></figure>
<h1 id="四、cglib代理"><a href="#四、cglib代理" class="headerlink" title="四、cglib代理"></a>四、cglib代理</h1><blockquote>
<p>cglib is a powerful, high performance and quality Code Generation Library. It can extend JAVA classes and implement interfaces at runtime.</p>
</blockquote>
<p><a href="https://github.com/cglib/cglib" target="_blank" rel="external">cglib</a>   (Code Generation Library )是一个第三方代码生成类库，运行时在内存中动态生成一个子类对象从而实现对目标对象功能的扩展。</p>
<p><strong>cglib特点</strong></p>
<ul>
<li>JDK的动态代理有一个限制，就是使用动态代理的对象必须实现一个或多个接口。<br>如果想代理没有实现接口的类，就可以使用CGLIB实现。 </li>
<li>CGLIB是一个强大的高性能的代码生成包，它可以在运行期扩展Java类与实现Java接口。<br>它广泛的被许多AOP的框架使用，例如Spring AOP和dynaop，为他们提供方法的interception（拦截）。 </li>
<li>CGLIB包的底层是通过使用一个小而快的字节码处理框架ASM，来转换字节码并生成新的类。<br>不鼓励直接使用ASM，因为它需要你对JVM内部结构包括class文件的格式和指令集都很熟悉。</li>
</ul>
<p>cglib与动态代理最大的<strong>区别</strong>就是</p>
<ul>
<li>使用动态代理的对象必须实现一个或多个接口</li>
<li>使用cglib代理的对象则无需实现接口，达到代理类无侵入。</li>
</ul>
<p>使用cglib需要引入<a href="https://repo1.maven.org/maven2/cglib/cglib/3.2.5/cglib-3.2.5.jar" target="_blank" rel="external">cglib的jar包</a>，如果你已经有spring-core的jar包，则无需引入，因为spring中包含了cglib。</p>
<ul>
<li>cglib的Maven坐标<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>举例：保存用户功能的动态代理实现</p>
</blockquote>
<ul>
<li>目标对象：UserDao</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.cglib;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDao</span></span>&#123;</div><div class="line"></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</div><div class="line">truetrueSystem.out.println(<span class="string">"保存数据"</span>);</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>代理对象：ProxyFactory</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.cglib;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.lang.reflect.Method;</div><div class="line"></div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.Enhancer;</div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodInterceptor;</div><div class="line"><span class="keyword">import</span> net.sf.cglib.proxy.MethodProxy;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyFactory</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span></span>&#123;</div><div class="line"></div><div class="line">true<span class="keyword">private</span> Object target;<span class="comment">//维护一个目标对象</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="title">ProxyFactory</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">truetrue<span class="keyword">this</span>.target = target;</div><div class="line">true&#125;</div><div class="line">true</div><div class="line">true<span class="comment">//为目标对象生成代理对象</span></div><div class="line">true<span class="function"><span class="keyword">public</span> Object <span class="title">getProxyInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">truetrue<span class="comment">//工具类</span></div><div class="line">truetrueEnhancer en = <span class="keyword">new</span> Enhancer();</div><div class="line">truetrue<span class="comment">//设置父类</span></div><div class="line">truetrueen.setSuperclass(target.getClass());</div><div class="line">truetrue<span class="comment">//设置回调函数</span></div><div class="line">truetrueen.setCallback(<span class="keyword">this</span>);</div><div class="line">truetrue<span class="comment">//创建子类对象代理</span></div><div class="line">truetrue<span class="keyword">return</span> en.create();</div><div class="line">true&#125;</div><div class="line"></div><div class="line">true<span class="meta">@Override</span></div><div class="line">true<span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">truetrueSystem.out.println(<span class="string">"开启事务"</span>);</div><div class="line">truetrue<span class="comment">// 执行目标对象的方法</span></div><div class="line">truetrueObject returnValue = method.invoke(target, args);</div><div class="line">truetrueSystem.out.println(<span class="string">"关闭事务"</span>);</div><div class="line">truetrue<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>测试类：TestProxy </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.cglib;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.junit.Test;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProxy</span> </span>&#123;</div><div class="line"></div><div class="line">true<span class="meta">@Test</span></div><div class="line">true<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCglibProxy</span><span class="params">()</span></span>&#123;</div><div class="line">truetrue<span class="comment">//目标对象</span></div><div class="line">truetrueUserDao target = <span class="keyword">new</span> UserDao();</div><div class="line">truetrueSystem.out.println(target.getClass());</div><div class="line">truetrue<span class="comment">//代理对象</span></div><div class="line">truetrueUserDao proxy = (UserDao) <span class="keyword">new</span> ProxyFactory(target).getProxyInstance();</div><div class="line">truetrueSystem.out.println(proxy.getClass());</div><div class="line">truetrue<span class="comment">//执行代理对象方法</span></div><div class="line">truetrueproxy.save();</div><div class="line">true&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>输出结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">class com.cglib.UserDao</div><div class="line">class com.cglib.UserDao$<span class="variable">$EnhancerByCGLIB</span>$<span class="variable">$552188b6</span></div><div class="line">开启事务</div><div class="line">保存数据</div><div class="line">关闭事务</div></pre></td></tr></table></figure>
<h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><ol>
<li><p>静态代理实现较简单，只要代理对象对目标对象进行包装，即可实现增强功能，但静态代理只能为一个目标对象服务，如果目标对象过多，则会产生很多代理类。</p>
</li>
<li><p>JDK动态代理需要目标对象实现业务接口，代理类只需实现InvocationHandler接口。</p>
</li>
<li><p>动态代理生成的类为 lass com.sun.proxy.$Proxy4，cglib代理生成的类为class com.cglib.UserDao$$EnhancerByCGLIB$$552188b6。</p>
</li>
<li><p>静态代理在编译时产生class字节码文件，可以直接使用，效率高。</p>
</li>
<li><p>动态代理必须实现InvocationHandler接口，通过反射代理方法，比较消耗系统性能，但可以减少代理类的数量，使用更灵活。</p>
</li>
<li><p>cglib代理无需实现接口，通过生成类字节码实现代理，比反射稍快，不存在性能问题，但cglib会继承目标对象，需要重写方法，所以目标对象不能为final类。</p>
</li>
</ol>
<h1 id="六、相关资料"><a href="#六、相关资料" class="headerlink" title="六、相关资料"></a>六、相关资料</h1><p>代理模式相关知识</p>
<ul>
<li><a href="http://www.jianshu.com/p/6f6bb2f0ece9" target="_blank" rel="external">代理模式及Java实现动态代理</a></li>
<li><a href="http://blog.csdn.net/chenssy/article/details/11179815" target="_blank" rel="external">设计模式读书笔记 - 代理模式</a></li>
<li><a href="http://rejoy.iteye.com/blog/1627405" target="_blank" rel="external">JDK动态代理实现原理</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-proxy1/" target="_blank" rel="external">Java 动态代理机制分析及扩展</a></li>
<li><a href="http://www.cnblogs.com/fillPv/p/5939277.html" target="_blank" rel="external">Java代理(jdk静态代理、动态代理和cglib动态代理)</a></li>
<li><a href="http://blog.csdn.net/dreamrealised/article/details/12885739" target="_blank" rel="external">AOP的底层实现-CGLIB动态代理和JDK动态代理</a></li>
<li><a href="http://llying.iteye.com/blog/220452" target="_blank" rel="external">深入浅出CGlib-打造无入侵的类代理</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/java/j-lo-springaopcglib/" target="_blank" rel="external">Spring AOP 实现原理与 CGLIB 应用</a></li>
</ul>
<p>UML相关知识</p>
<ul>
<li><a href="https://yq.aliyun.com/articles/75556" target="_blank" rel="external">博客 - UML类图与类的关系详解</a></li>
<li><a href="https://books.google.com.hk/books?id=dU--JuYudxgC&amp;pg=PA18&amp;lpg=PA18&amp;dq=uml%E8%AF%A6%E8%A7%A3&amp;source=bl&amp;ots=ay5tHhDK0l&amp;sig=_Fj_cEmG9ZSN5S3HHl1SrNcmcKw&amp;hl=zh-CN&amp;sa=X&amp;ved=0ahUKEwiR14Kg45LVAhXL44MKHRZHD3Y4ChDoAQg3MAQ#v=onepage&amp;q=uml%E8%AF%A6%E8%A7%A3&amp;f=false" target="_blank" rel="external">goole图书 -《UML建模实例详解》</a></li>
</ul>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="http://link.hhtjim.com/163/425570952.mp3">
            </audio>
        </div>
        

    </div>
</div>

    </div>
</div>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>



</html>